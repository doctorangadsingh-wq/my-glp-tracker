<!DOCTYPE html>
<html lang="en-GB">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>GLP-1 Tracker</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
    <style>
        :root {
            --bg-color: #F2F2F7;
            --accent-blue: #007AFF;
            --card-bg: rgba(255, 255, 255, 0.9);
            --text-main: #1C1C1E;
            --text-sec: #8E8E93;
        }
        body {
            font-family: -apple-system, sans-serif;
            background: linear-gradient(180deg, #E5E5EA 0%, #F2F2F7 100%);
            margin: 0; padding: 15px;
            color: var(--text-main);
            min-height: 100vh;
        }
        .card {
            background: var(--card-bg);
            border-radius: 15px;
            padding: 15px;
            margin-bottom: 12px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            backdrop-filter: blur(10px);
        }
        .header { font-size: 24px; font-weight: 700; margin-bottom: 20px; }
        .dose-active { border-left: 5px solid var(--accent-blue); }
        .stat-val { font-size: 24px; font-weight: 700; color: var(--accent-blue); }
        .label { font-size: 12px; color: var(--text-sec); text-transform: uppercase; font-weight: 600; }
        input {
            width: 100%; padding: 12px; margin: 8px 0;
            border: 1px solid #DDD; border-radius: 10px; font-size: 16px;
            box-sizing: border-box;
        }
        button {
            background: var(--accent-blue); color: white; border: none;
            width: 100%; padding: 15px; border-radius: 12px;
            font-weight: 600; font-size: 16px; margin-top: 10px;
        }
        .bmi-tag { font-size: 12px; padding: 3px 8px; border-radius: 5px; margin-left: 10px; }
        .bmi-ok { background: #E1F5FE; color: #01579B; }
        .chart-wrap { height: 250px; width: 100%; }
        #setupModal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: white; z-index: 100; display: none; flex-direction: column;
            justify-content: center; padding: 30px; box-sizing: border-box;
        }
    </style>
</head>
<body>

    <div id="setupModal">
        <h1>Initial Setup</h1>
        <label>First Dose Date</label>
        <input type="date" id="setupDate">
        <label>Height (cm)</label>
        <input type="number" id="setupHeight" placeholder="175">
        <button onclick="saveProfile()">Start Journey</button>
    </div>

    <div class="header">My Journey</div>

    <div class="card dose-active">
        <div class="label">Next Shot Due</div>
        <div id="doseCountdown" class="stat-val">Calculating...</div>
        <div id="doseDateDisplay" style="font-size: 14px; color: #8E8E93;"></div>
    </div>

    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
        <div class="card">
            <div class="label">Weight</div>
            <div id="weightDisplay" class="stat-val">-- <small>kg</small></div>
        </div>
        <div class="card">
            <div class="label">BMI</div>
            <div id="bmiDisplay" class="stat-val">--</div>
            <span id="bmiTag" class="bmi-tag" style="display:none">Normal</span>
        </div>
    </div>

    <div class="card">
        <div class="label">Progress & Calories</div>
        <div class="chart-wrap"><canvas id="mainChart"></canvas></div>
    </div>

    <div class="card">
        <div class="label">New Entry</div>
        <input type="number" step="0.1" id="inWeight" placeholder="Weight (kg)">
        <input type="number" id="inCals" placeholder="Calories (Kcal)">
        <input type="number" step="0.1" id="inWater" placeholder="Water (Liters)">
        <input type="date" id="inDate">
        <button onclick="saveEntry()">Save Entry</button>
    </div>

    <script>
        let profile = JSON.parse(localStorage.getItem('gp_profile'));
        let logs = JSON.parse(localStorage.getItem('gp_logs')) || [];
        let chart = null;

        window.onload = () => {
            if (!profile) document.getElementById('setupModal').style.display = 'flex';
            document.getElementById('inDate').valueAsDate = new Date();
            init();
        };

        function saveProfile() {
            const d = document.getElementById('setupDate').value;
            const h = document.getElementById('setupHeight').value;
            if (d && h) {
                profile = { start: d, height: h };
                localStorage.setItem('gp_profile', JSON.stringify(profile));
                location.reload();
            }
        }

        function init() {
            if (!profile) return;
            updateDose();
            updateStats();
            renderChart();
        }

        function updateDose() {
            // Logic: Calculate exactly based on days from start date
            const start = new Date(profile.start);
            start.setHours(0,0,0,0);
            const today = new Date();
            today.setHours(0,0,0,0);

            const diffMs = today - start;
            const diffDays = Math.floor(diffMs / (1000 * 60 * 60 * 24));
            
            // Weekly logic: Next dose is at the next 7-day milestone
            let daysRemaining = 7 - (diffDays % 7);
            if (daysRemaining === 7 && diffDays >= 0) daysRemaining = 0; // It's today

            const nextDoseDate = new Date(today);
            nextDoseDate.setDate(today.getDate() + daysRemaining);

            const countdownText = daysRemaining === 0 ? "DUE TODAY" : 
                                 (daysRemaining === 1 ? "1 day left" : `${daysRemaining} days left`);
            
            document.getElementById('doseCountdown').innerText = countdownText;
            document.getElementById('doseDateDisplay').innerText = nextDoseDate.toLocaleDateString('en-GB');
        }

        function updateStats() {
            if (logs.length === 0) return;
            const latest = [...logs].sort((a,b) => new Date(b.date) - new Date(a.date))[0];
            document.getElementById('weightDisplay').innerHTML = `${latest.weight} <small>kg</small>`;
            
            const hM = profile.height / 100;
            const bmi = (latest.weight / (hM * hM)).toFixed(1);
            document.getElementById('bmiDisplay').innerText = bmi;
            
            const tag = document.getElementById('bmiTag');
            tag.style.display = 'inline-block';
            tag.innerText = bmi < 25 ? "Normal" : (bmi < 30 ? "Overweight" : "Obese");
        }

        function saveEntry() {
            const w = parseFloat(document.getElementById('inWeight').value);
            const c = parseInt(document.getElementById('inCals').value);
            const d = document.getElementById('inDate').value;
            if (!d) return alert("Date required");
            
            logs.push({ date: d, weight: w || 0, cals: c || 0 });
            localStorage.setItem('gp_logs', JSON.stringify(logs));
            alert("Saved");
            location.reload();
        }

        function renderChart() {
            const ctx = document.getElementById('mainChart').getContext('2d');
            const data = [...logs].sort((a,b) => new Date(a.date) - new Date(b.date));
            
            if (chart) chart.destroy();
            chart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: data.map(l => l.date),
                    datasets: [
                        { label: 'Weight', data: data.map(l => l.weight), borderColor: '#007AFF', tension: 0.3, yAxisID: 'y' },
                        { label: 'Cals', data: data.map(l => l.cals), type: 'bar', backgroundColor: 'rgba(255, 149, 0, 0.3)', yAxisID: 'y1' }
                    ]
                },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    scales: {
                        x: { type: 'time', time: { unit: 'day' }, grid: { display: false } },
                        y: { position: 'left', title: { display: true, text: 'kg' } },
                        y1: { position: 'right', grid: { display: false }, title: { display: true, text: 'kcal' } }
                    }
                }
            });
        }
    </script>
</body>
</html>
