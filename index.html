<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Health OS v2</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --bg-color: #F2F2F7;
            --card-bg: #FFFFFF;
            --text-primary: #1C1C1E;
            --text-secondary: #8E8E93;
            --accent-blue: #007AFF;
            --accent-green: #34C759;
            --accent-red: #FF3B30;
            --accent-orange: #FF9500;
            --accent-grey: #8E8E93;
            --radius: 20px;
            --shadow: 0 4px 20px rgba(0,0,0,0.05);
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-primary);
            margin: 0;
            padding: 20px;
            -webkit-font-smoothing: antialiased;
        }

        h1, h2, h3 { margin: 0; font-weight: 700; }
        
        .container {
            max-width: 800px;
            margin: 0 auto;
            padding-bottom: 50px;
        }

        /* --- UI COMPONENTS --- */
        .card {
            background: var(--card-bg);
            border-radius: var(--radius);
            padding: 24px;
            box-shadow: var(--shadow);
            margin-bottom: 20px;
            transition: transform 0.2s;
        }

        .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        .grid-3 { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px; }

        .stat-box {
            background: #F9F9F9;
            padding: 15px;
            border-radius: 12px;
            text-align: center;
        }
        .stat-value { font-size: 20px; font-weight: 800; display: block; margin-top: 5px; }
        .stat-label { font-size: 11px; color: var(--text-secondary); text-transform: uppercase; letter-spacing: 0.5px; }

        .btn {
            background: var(--accent-blue);
            color: white;
            border: none;
            padding: 15px;
            border-radius: 12px;
            width: 100%;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            margin-top: 10px;
        }
        .btn:hover { opacity: 0.9; }

        input, select {
            width: 100%;
            padding: 12px;
            border-radius: 10px;
            border: 1px solid #E5E5EA;
            background: #F2F2F7;
            font-size: 16px;
            margin-bottom: 10px;
            box-sizing: border-box;
        }
        input:focus { outline: none; border-color: var(--accent-blue); background: #fff; }

        /* --- SPECIFIC SECTIONS --- */
        
        /* Setup Modal */
        #setup-modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(255,255,255,0.95);
            backdrop-filter: blur(10px);
            z-index: 100;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .setup-content {
            background: white;
            padding: 40px;
            border-radius: 30px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.1);
            width: 90%;
            max-width: 400px;
            text-align: center;
        }

        /* Toggles */
        .toggle-group {
            display: flex;
            background: #E5E5EA;
            padding: 4px;
            border-radius: 10px;
            margin-bottom: 15px;
        }
        .toggle-option {
            flex: 1;
            padding: 10px;
            text-align: center;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            font-size: 14px;
            color: var(--text-secondary);
        }
        .toggle-option.active {
            background: white;
            color: var(--text-primary);
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        /* Indicators */
        .tick { color: var(--accent-green); font-weight: bold; }
        .cross { color: var(--accent-red); font-weight: bold; }

        /* Graph Container */
        .chart-container {
            position: relative; 
            height: 350px; 
            width: 100%;
        }

        /* Velocity & Predictions */
        .velocity-card { background: linear-gradient(135deg, #007AFF, #5856D6); color: white; }
        .velocity-card .stat-label { color: rgba(255,255,255,0.7); }
        .velocity-card .stat-value { color: white; }
        .motivation-text {
            font-size: 14px; 
            color: rgba(255,255,255,0.9); 
            text-align: center; 
            margin-top: 15px; 
            padding-top: 15px; 
            border-top: 1px solid rgba(255,255,255,0.2);
            line-height: 1.4;
        }

        /* GLP-1 Badge */
        .dose-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: bold;
            color: white;
            margin-left: 10px;
        }
        .dose-2-5 { background-color: var(--accent-green); }
        .dose-5 { background-color: var(--accent-red); }
        .dose-none { background-color: var(--accent-grey); }

    </style>
</head>
<body>

    <div id="setup-modal" style="display:none;">
        <div class="setup-content">
            <h2>Welcome</h2>
            <p style="color:var(--text-secondary); margin-bottom: 20px;">We need accurate stats for the calorie engine.</p>
            
            <label style="text-align:left; display:block; font-size:12px; margin-bottom:5px;">Your Height (cm)</label>
            <input type="number" id="setup-height" placeholder="e.g. 175">
            
            <label style="text-align:left; display:block; font-size:12px; margin-bottom:5px;">Starting Weight (kg)</label>
            <input type="number" id="setup-weight" placeholder="e.g. 90">

            <div class="grid-2">
                <div>
                    <label style="text-align:left; display:block; font-size:12px; margin-bottom:5px;">Age</label>
                    <input type="number" id="setup-age" placeholder="30">
                </div>
                <div>
                    <label style="text-align:left; display:block; font-size:12px; margin-bottom:5px;">Gender</label>
                    <select id="setup-gender">
                        <option value="male">Male</option>
                        <option value="female">Female</option>
                    </select>
                </div>
            </div>

            <button class="btn" onclick="saveSetup()">Start Tracking</button>
        </div>
    </div>

    <div class="container" id="app-container">
        
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
            <div>
                <h1>Health OS</h1>
                <span id="current-date" style="color:var(--text-secondary); font-size: 14px;">Today</span>
            </div>
            <div id="bmi-pill" style="background:#E5E5EA; padding: 5px 15px; border-radius: 20px; font-weight: 700; font-size: 14px;">
                BMI: --
            </div>
        </div>

        <div class="card velocity-card">
            <div class="grid-3">
                <div class="stat-box" style="background:rgba(255,255,255,0.1);">
                    <span class="stat-label">Daily BMR</span>
                    <span class="stat-value" id="bmr-value">--</span>
                </div>
                <div class="stat-box" style="background:rgba(255,255,255,0.1);">
                    <span class="stat-label">Today's Deficit</span>
                    <span class="stat-value" id="today-deficit">--</span>
                </div>
                <div class="stat-box" style="background:rgba(255,255,255,0.1);">
                    <span class="stat-label">Net Loss</span>
                    <span class="stat-value" id="net-loss">-- kg</span>
                </div>
            </div>
            <div class="motivation-text" id="prediction-text">
                Log today's calories to see your 30-day potential.
            </div>
        </div>

        <div class="card">
            <div style="display:flex; justify-content:space-between; align-items:center;">
                <h3>GLP-1 Status</h3>
                <span id="next-dose-date" style="font-weight:600; color:var(--accent-blue);">--</span>
            </div>
            <div style="margin-top: 15px;" class="grid-2">
                <div>
                    <label class="stat-label">Date</label>
                    <input type="date" id="glp-date">
                </div>
                <div>
                    <label class="stat-label">Dosage</label>
                    <div class="toggle-group" id="glp-toggle">
                        <div class="toggle-option" onclick="setDose(0, this)">None</div>
                        <div class="toggle-option active" onclick="setDose(2.5, this)">2.5</div>
                        <div class="toggle-option" onclick="setDose(5, this)">5.0</div>
                    </div>
                </div>
            </div>
        </div>

        <div class="card">
            <h3>Progress Overview</h3>
            <p style="font-size:12px; color:var(--text-secondary);">Weight (Color coded by dose) vs Calories</p>
            <div class="chart-container">
                <canvas id="mainChart"></canvas>
            </div>
        </div>

        <div class="card">
            <h3>Daily Log</h3>
            <div class="grid-2">
                <div>
                    <label class="stat-label">Weight (kg)</label>
                    <input type="number" id="daily-weight" step="0.1">
                </div>
                <div>
                    <label class="stat-label">Calories</label>
                    <input type="number" id="daily-calories">
                </div>
                <div>
                    <label class="stat-label">Protein (g)</label>
                    <input type="number" id="daily-protein">
                </div>
                <div style="display:flex; align-items:center; justify-content: space-between; padding-top:20px;">
                    <label class="stat-label">Exercise? (+200kcal)</label>
                    <input type="checkbox" id="daily-exercise" style="width:25px; height:25px; margin:0;">
                </div>
            </div>
            <div class="grid-2">
                <div>
                    <label class="stat-label">Chest (cm)</label>
                    <input type="number" id="daily-chest">
                </div>
                <div>
                    <label class="stat-label">Waist (cm)</label>
                    <input type="number" id="daily-waist">
                </div>
            </div>
            <button class="btn" onclick="addEntry()">Log Today</button>
        </div>

        <div class="card">
            <h3>Recent History</h3>
            <table style="width:100%; text-align:left; border-collapse: collapse; margin-top:15px; font-size:14px;">
                <thead>
                    <tr style="border-bottom: 1px solid #E5E5EA; color:var(--text-secondary);">
                        <th style="padding:10px 0;">Date</th>
                        <th>Wt</th>
                        <th>Cal.</th>
                        <th>Dose</th>
                    </tr>
                </thead>
                <tbody id="history-body">
                    </tbody>
            </table>
        </div>

    </div>

<script>
    // --- STATE MANAGEMENT ---
    let appData = {
        settings: {
            height: null,
            startWeight: null,
            age: 30,
            gender: 'male',
            startDate: null
        },
        entries: [] 
    };

    let currentDoseSelection = 2.5;

    // --- INITIALIZATION ---
    window.onload = function() {
        const storedData = localStorage.getItem('healthApp_v2');
        document.getElementById('current-date').innerText = new Date().toLocaleDateString('en-US', { weekday: 'long', month: 'long', day: 'numeric' });
        
        // Set default date for GLP input
        document.getElementById('glp-date').valueAsDate = new Date();

        if (storedData) {
            appData = JSON.parse(storedData);
            // Migration check for old data (if upgrading from v1 to v2)
            if(!appData.settings.age) appData.settings.age = 30;
            renderDashboard();
        } else {
            document.getElementById('setup-modal').style.display = 'flex';
        }
    };

    // --- SETUP LOGIC ---
    function saveSetup() {
        const h = parseFloat(document.getElementById('setup-height').value);
        const w = parseFloat(document.getElementById('setup-weight').value);
        const a = parseFloat(document.getElementById('setup-age').value);
        const g = document.getElementById('setup-gender').value;
        
        if (!h || !w || !a) return alert("Please fill all fields");

        appData.settings.height = h;
        appData.settings.startWeight = w;
        appData.settings.age = a;
        appData.settings.gender = g;
        appData.settings.startDate = new Date().toISOString().split('T')[0];
        
        saveData();
        document.getElementById('setup-modal').style.display = 'none';
        renderDashboard();
    }

    function setDose(amount, el) {
        currentDoseSelection = amount;
        const options = document.querySelectorAll('.toggle-option');
        options.forEach(opt => opt.classList.remove('active'));
        el.classList.add('active');
    }

    // --- CORE FUNCTIONS ---
    function addEntry() {
        const date = new Date().toISOString().split('T')[0];
        const weight = parseFloat(document.getElementById('daily-weight').value);
        const calories = parseFloat(document.getElementById('daily-calories').value);
        const protein = parseFloat(document.getElementById('daily-protein').value);
        const exercise = document.getElementById('daily-exercise').checked;
        const chest = parseFloat(document.getElementById('daily-chest').value) || null;
        const waist = parseFloat(document.getElementById('daily-waist').value) || null;
        
        const glpDateInput = document.getElementById('glp-date').value;

        // Validation
        if (!weight || !calories) {
            alert("Please enter at least Weight and Calories.");
            return;
        }
        
        appData.entries = appData.entries.filter(e => e.date !== date);

        const newEntry = {
            date,
            weight,
            calories,
            protein,
            exercise,
            chest,
            waist,
            glpDose: currentDoseSelection, 
            glpInjectionDate: glpDateInput 
        };

        appData.entries.push(newEntry);
        appData.entries.sort((a, b) => new Date(a.date) - new Date(b.date));

        saveData();
        renderDashboard();
        
        // Clear inputs
        document.getElementById('daily-weight').value = '';
        document.getElementById('daily-calories').value = '';
        document.getElementById('daily-protein').value = '';
        document.getElementById('daily-exercise').checked = false;
    }

    function saveData() {
        localStorage.setItem('healthApp_v2', JSON.stringify(appData));
    }

    // --- CALCULATIONS & RENDERING ---
    function renderDashboard() {
        const entries = appData.entries;
        
        // 1. GLP Timer Logic (Runs even without entries)
        const glpDateVal = document.getElementById('glp-date').value;
        if (glpDateVal) {
            const inputDate = new Date(glpDateVal);
            inputDate.setHours(0,0,0,0);
            const today = new Date();
            today.setHours(0,0,0,0);

            const diffTime = inputDate - today;
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));

            let msg = "";
            if (diffDays > 0) {
                // Future date
                msg = `Next Dose: In ${diffDays} days`;
            } else {
                // Past or Today
                // Logic: If injection was in past, next one is Injection + 7
                const nextDose = new Date(inputDate);
                nextDose.setDate(inputDate.getDate() + 7);
                const daysUntilNext = Math.ceil((nextDose - today) / (1000 * 60 * 60 * 24));
                
                if (daysUntilNext === 0) msg = "Dose Due Today!";
                else if (daysUntilNext < 0) msg = `Overdue by ${Math.abs(daysUntilNext)} days`;
                else msg = `Next Dose: In ${daysUntilNext} days`;
            }
            document.getElementById('next-dose-date').innerText = msg;
        }

        if (entries.length === 0) return;
        const latest = entries[entries.length - 1];

        // 2. BMI
        const heightM = appData.settings.height / 100;
        const bmi = (latest.weight / (heightM * heightM)).toFixed(1);
        document.getElementById('bmi-pill').innerText = `BMI: ${bmi}`;

        // 3. Net Loss
        const loss = (appData.settings.startWeight - latest.weight).toFixed(1);
        document.getElementById('net-loss').innerText = `-${loss} kg`;

        // 4. METABOLIC ENGINE (BMR & Deficit)
        // Mifflin-St Jeor Equation
        // Men: 10W + 6.25H - 5A + 5
        // Women: 10W + 6.25H - 5A - 161
        let bmr = (10 * latest.weight) + (6.25 * appData.settings.height) - (5 * appData.settings.age);
        if (appData.settings.gender === 'male') bmr += 5;
        else bmr -= 161;

        let maintenance = bmr * 1.2; // Sedentary baseline
        if (latest.exercise) maintenance += 200; // User rule: Add 200 if exercise

        const deficit = maintenance - latest.calories;
        
        document.getElementById('bmr-value').innerText = Math.round(maintenance);
        
        const defEl = document.getElementById('today-deficit');
        if(deficit > 0) {
            defEl.innerText = `-${Math.round(deficit)}`;
            defEl.style.color = '#34C759'; // Green
        } else {
            defEl.innerText = `+${Math.round(Math.abs(deficit))}`;
            defEl.style.color = '#FF3B30'; // Red
        }

        // 5. Prediction (30 Days)
        // 7700kcal = 1kg fat
        const predictedLoss = (deficit * 30) / 7700;
        const projectedWeight = (latest.weight - predictedLoss).toFixed(1);
        
        let motivationHTML = "";
        if (deficit > 0) {
            motivationHTML = `If every day was like today, you'd lose <strong>${predictedLoss.toFixed(1)} kg</strong> in 30 days.<br>Projected Weight: <strong>${projectedWeight} kg</strong>`;
        } else {
            motivationHTML = `You are in a surplus today. To lose weight, aim for calories below ${Math.round(maintenance)}.`;
        }
        document.getElementById('prediction-text').innerHTML = motivationHTML;


        // 6. Update History Table
        const tbody = document.getElementById('history-body');
        tbody.innerHTML = '';
        [...entries].reverse().slice(0, 5).forEach(e => {
            let doseBadge = 'dose-none';
            if (e.glpDose == 2.5) doseBadge = 'dose-2-5';
            if (e.glpDose == 5.0) doseBadge = 'dose-5';
            
            const row = `<tr>
                <td style="padding:10px 0; color:var(--text-secondary);">${e.date.slice(5)}</td>
                <td style="font-weight:600;">${e.weight}</td>
                <td>${e.calories}</td>
                <td><span class="dose-badge ${doseBadge}">${e.glpDose > 0 ? e.glpDose + 'mg' : 'Off'}</span></td>
            </tr>`;
            tbody.innerHTML += row;
        });

        updateChart(entries);
    }

    // --- CHART LOGIC ---
    let myChart;

    function updateChart(data) {
        const ctx = document.getElementById('mainChart').getContext('2d');
        const labels = data.map(e => e.date.slice(5)); 
        const weights = data.map(e => e.weight);
        const calories = data.map(e => e.calories);
        
        // Color mapping
        const segmentColors = data.map(e => {
            if (e.glpDose == 2.5) return '#34C759'; // Green
            if (e.glpDose == 5.0) return '#FF3B30'; // Red
            return '#8E8E93'; // Grey (None)
        });

        if (myChart) myChart.destroy();

        myChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: labels,
                datasets: [
                    {
                        label: 'Calories',
                        data: calories,
                        type: 'bar',
                        yAxisID: 'y1',
                        backgroundColor: 'rgba(0, 122, 255, 0.15)',
                        borderRadius: 4,
                        barThickness: 10
                    },
                    {
                        label: 'Weight',
                        data: weights,
                        yAxisID: 'y',
                        borderColor: '#8E8E93',
                        borderWidth: 3,
                        tension: 0.3,
                        pointBackgroundColor: '#fff',
                        pointBorderWidth: 2,
                        segment: {
                            borderColor: ctx => {
                                const index = ctx.p1DataIndex; 
                                return segmentColors[index];
                            }
                        }
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                interaction: {
                    mode: 'index',
                    intersect: false,
                },
                plugins: {
                    legend: { display: false }
                },
                scales: {
                    y: {
                        type: 'linear',
                        display: true,
                        position: 'left',
                        grid: { display: false }
                    },
                    y1: {
                        type: 'linear',
                        display: true,
                        position: 'right',
                        grid: { color: '#F2F2F7' },
                        min: 0
                    },
                    x: {
                        grid: { display: false }
                    }
                }
            }
        });
    }

</script>
</body>
</html>
